#!/bin/sh
# song v1.0 by vifino.
# A small music player controller.
# Supports: MPD, CMUS and Spotify on OSX.
set -e

usage() {
	cat <<EOF
song: A utility to control some media players and get the playing song.
Usage: song [cmd] [args..]
Commands:
 playing:       Check if a song is playing.
    name:       Get the playing song if the player is playing.
   pause:       Pause the playing song.
    play:       Resume playing.
  toggle:       Toggle playing.
    next:       Skip to the next song.
    prev:       Go to the last song/beginning of the current song.
   vol N:       Set the volume to N.
EOF
}

# Interfaces to the players.
export MPC_FORMAT="[[%artist% - ]%title%]|[%file%]"
mpd() {
	case "$1" in
		playing) mpc status -f "" | grep playing >/dev/null ;;
		name) mpc current ;;
		play|pause|toggle|next|prev) mpc -q $1; mpc current ;;
		stop) mpc -q $1 ;;
		vol) mpc -q "$@" | cut -d" " -f2 ;;
		*) echo "Unknown command: $1"; usage; return 1 ;;
	esac
}

cmus() {
	case "$1" in
		playing) cmus-remote -Q | grep -m 1 playing >/dev/null ;;
		name) cmus-remote -C "format_print '%a - %t'" ;;
		play|pause|next|prev) cmus-remote --$1 && cmus name ;;
		toggle) cmus playing && cmus pause || cmus play ;;
		stop) cmus-remote --$1 ;;
		vol)
			if [ -z "$2" ]; then
				cmus-remote -Q | grep vol_right | cut -d" " -f3
			else
				cmus-remote -v $2
			fi ;;
		*) echo "Unknown command: $1"; usage; return 1 ;;
	esac
}

spotify_mac() {
	# On Macs we have to use different things.
	# Because OSX has to always be incompatible. Duh.
	TS() {
		osascript -e "tell application \"Spotify\" to $*"
	}
	case "$1" in
		playing) [ "$(TS player state as string)" = "playing" ] ;;
		name) printf "%s - %s\n" "$(TS artist of current track as string)" "$(TS name of current track as string)" ;;
		toggle) TS playpause ;;
		play) spotify_mac playing || TS playpause ;;
		pause) spotify_mac playing && TS playpause ;;
		next) TS next track ;;
		prev) TS previous track ;;
		stop) spotify_mac pause ;; # there is no stop apparently.
		vol)
			if [ -z "$2" ]; then
				TS sound volume as integer
			else
				TS set sound volume to "$2"
			fi ;;
		*) echo "Unknown command: $1"; usage; return 1 ;;
	esac
}

# Our interface.
CMD="$1"
[ -z "$CMD" ] && CMD=name || shift

if [ ! -z "$MPD_HOST" ] || running mpd; then
	mpd "$CMD" "$@"
	exit
fi

if running cmus; then
	cmus "$CMD" "$@"
	exit
fi

if [ `uname` == "Darwin" ] && running Spotify; then
	spotify_mac "$CMD" "$@"
	exit
fi

echo "No supported players found. Currently supports: mpd, cmus, Spotify (OSX)."
exit 1
